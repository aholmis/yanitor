@page "/house-builder"
@page "/{culture}/house-builder"
@using Microsoft.Extensions.Localization
@using Yanitor.Web.Domain
@using Yanitor.Web.Domain.Models
@using Yanitor.Web.Domain.Services
@using Yanitor.Web.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IStringLocalizer<HouseBuilder> L
@inject IStringLocalizer<HouseItemResources> ItemL
@inject IHouseConfigurationService HouseConfigService
@inject IItemProvider ItemProvider
@inject NavigationManager Navigation
@inject IActiveTaskService TaskService
@inject IUserContext UserContext
@rendermode InteractiveServer

<PageTitle>@L["PageTitle"]</PageTitle>

<section class="house-builder">
    <header class="house-builder__header">
        <h1 class="house-builder__title">@L["PageTitle"]</h1>
        <p class="house-builder__subtitle">@L["Subtitle"]</p>
    </header>

    <div class="house-builder__content">
        <div class="house-builder__items">
            <h2 class="house-builder__items-title">@L["SelectItemsTitle"]</h2>
            <p class="house-builder__items-hint">@L["SelectItemsHint"]</p>
            <div class="house-builder__item-grid">
                @foreach (var item in _allItems)
                {
                    var typeKey = item.ItemType.ToString();
                    var isSelected = _selectedItemTypes.Contains(typeKey);
                    <button class="@(isSelected ? "house-item-button house-item-button--selected" : "house-item-button")" 
                            type="button"
                            @onclick="() => ToggleItem(typeKey)"
                            aria-pressed="@isSelected"
                            aria-label="@L["ToggleItemAria", GetDisplayItemName(item)]">
                        <span class="house-item-button__icon"><IconFactory Item="item" /></span>
                        <span class="house-item-button__name">@GetDisplayItemName(item)</span>
                    </button>
                }
            </div>
        </div>

        <div class="house-builder__actions">
            <button type="button" class="btn btn--secondary" @onclick="Cancel">
                @L["CancelButton"]
            </button>
            <button type="button" class="btn btn--primary btn--large"
                    @onclick="SaveConfiguration"
                    disabled="@(_selectedItemTypes.Count == 0)">
                @L["SaveButton"]
            </button>
        </div>
    </div>
</section>

@code {
    [Parameter]
    public string? Culture { get; set; }

    private List<HouseItem> _allItems = new();
    private HashSet<string> _selectedItemTypes = new(StringComparer.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        var config = await HouseConfigService.GetConfigurationAsync();
        if (config != null)
        {
            _selectedItemTypes = new HashSet<string>(config.SelectedItemTypes, StringComparer.OrdinalIgnoreCase);
        }

        _allItems = ItemProvider.GetAllItems().ToList();
    }

    private void ToggleItem(string itemType)
    {
        if (_selectedItemTypes.Contains(itemType))
        {
            _selectedItemTypes.Remove(itemType);
        }
        else
        {
            _selectedItemTypes.Add(itemType);
        }
    }

    private async Task SaveConfiguration()
    {
        // Persist the selected items; the service updates the in-memory configuration.
        await HouseConfigService.SetSelectedItemTypesAsync(_selectedItemTypes);

        // Ensure active tasks exist for the selected items
        await TaskService.SyncActiveTasksAsync();

        // Navigate to My House; HasConfigurationAsync should now be true.
        var url = !string.IsNullOrEmpty(Culture) ? $"/{Culture}/my-house" : "/my-house";
        Navigation.NavigateTo(url);
    }

    private string GetDisplayItemName(HouseItem item)
    {
        var specific = ItemL[$"Item_{item.Name}_Name"];
        if (!specific.ResourceNotFound && !string.IsNullOrWhiteSpace(specific.Value))
        {
            return specific.Value;
        }

        var typeKey = $"ItemType_{item.ItemType}_Name";
        var typeName = ItemL[typeKey];
        if (!typeName.ResourceNotFound && !string.IsNullOrWhiteSpace(typeName.Value))
        {
            return typeName.Value;
        }

        return item.Name;
    }

    private void Cancel()
    {
        var url = !string.IsNullOrEmpty(Culture) ? $"/{Culture}/my-house" : "/my-house";
        Navigation.NavigateTo(url);
    }
}
