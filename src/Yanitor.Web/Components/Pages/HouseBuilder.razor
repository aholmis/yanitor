@page "/house-builder"
@page "/{culture}/house-builder"
@using Microsoft.Extensions.Localization
@using Yanitor.Web.Domain
@using Yanitor.Web.Domain.Models
@using Yanitor.Web.Domain.Services
@inject IStringLocalizer<HouseBuilder> L
@inject IHouseConfigurationService HouseConfigService
@inject IItemProvider ItemProvider
@inject NavigationManager Navigation
@inject IActiveTaskService TaskService
@rendermode InteractiveServer

<PageTitle>@L["PageTitle"]</PageTitle>

<section class="house-builder">
    <header class="house-builder__header">
        <h1 class="house-builder__title">@L["PageTitle"]</h1>
        <p class="house-builder__subtitle">@L["Subtitle"]</p>
    </header>

    <div class="house-builder__content">
        <div class="house-builder__items">
            <h2 class="house-builder__items-title">@L["SelectItemsTitle"]</h2>
            <p class="house-builder__items-hint">@L["SelectItemsHint"]</p>
            <div class="house-builder__item-grid">
                @foreach (var item in _allItems)
                {
                    var typeKey = item.ItemType.ToString();
                    var isSelected = _selectedItemTypes.Contains(typeKey);
                    <button class="@(isSelected ? "house-item-button house-item-button--selected" : "house-item-button")" 
                            type="button"
                            @onclick="() => ToggleItem(typeKey)"
                            aria-pressed="@isSelected"
                            aria-label="@L["ToggleItemAria", item.Name]">
                        <span class="house-item-button__icon">@GetItemIcon(item)</span>
                        <span class="house-item-button__name">@item.Name</span>
                    </button>
                }
            </div>
        </div>

        <div class="house-builder__actions">
            <button type="button" class="btn btn--secondary" @onclick="Cancel">
                @L["CancelButton"]
            </button>
            <button type="button" class="btn btn--primary btn--large"
                    @onclick="SaveConfiguration"
                    disabled="@(_selectedItemTypes.Count == 0)">
                @L["SaveButton"]
            </button>
        </div>
    </div>
</section>

@code {
    [Parameter]
    public string? Culture { get; set; }

    private List<HouseItem> _allItems = new();
    private HashSet<string> _selectedItemTypes = new(StringComparer.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        var config = await HouseConfigService.GetConfigurationAsync();
        if (config != null)
        {
            _selectedItemTypes = new HashSet<string>(config.SelectedItemTypes, StringComparer.OrdinalIgnoreCase);
        }

        _allItems = ItemProvider.GetAllItems().ToList();
    }

    private void ToggleItem(string itemType)
    {
        if (_selectedItemTypes.Contains(itemType))
        {
            _selectedItemTypes.Remove(itemType);
        }
        else
        {
            _selectedItemTypes.Add(itemType);
        }
    }

    private async Task SaveConfiguration()
    {
        // Persist the selected items; the service updates the in-memory configuration.
        await HouseConfigService.SetSelectedItemTypesAsync(_selectedItemTypes);

        // Ensure active tasks exist for the selected items
        await TaskService.SyncActiveTasksAsync();

        // Navigate to My House; HasConfigurationAsync should now be true.
        var url = !string.IsNullOrEmpty(Culture) ? $"/{Culture}/my-house" : "/my-house";
        Navigation.NavigateTo(url);
    }

    private void Cancel()
    {
        var url = !string.IsNullOrEmpty(Culture) ? $"/{Culture}/my-house" : "/my-house";
        Navigation.NavigateTo(url);
    }

    private RenderFragment GetItemIcon(HouseItem item) => item.ItemType switch
    {
        HouseItemType.WashingMachine => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="4" y="3" width="16" height="18" rx="1.5" stroke="currentColor" stroke-width="2" />
            <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" />
            <path d="M9 13.5c.6 1 1.7 1.5 3 1.5 1.3 0 2.4-.5 3-1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
            <path d="M8 7.5h5.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
            <circle cx="16.5" cy="7.5" r="0.9" fill="currentColor" />
        </svg>,
        HouseItemType.Dishwasher => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="4" y="3" width="16" height="18" rx="1.5" stroke="currentColor" stroke-width="2" />
            <path d="M7 8h7.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
            <circle cx="16.5" cy="8" r="0.9" fill="currentColor" />
            <path d="M7 16.5c.5-1 1.3-1.5 2.3-1.5S11 15.5 11.5 16.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
            <path d="M12.5 16.5c.5-1 1.3-1.5 2.3-1.5s1.7.5 2.2 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
            <path d="M7 14h10" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
        </svg>,
        HouseItemType.BathroomSink => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M9 8a3 3 0 116 0v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            <path d="M5 11h14v3a3 3 0 01-3 3H8a3 3 0 01-3-3v-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <circle cx="12" cy="13" r="0.75" fill="currentColor" />
        </svg>,
        HouseItemType.BathtubDrain => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="4" y="10" width="16" height="6" rx="3" stroke="currentColor" stroke-width="2" />
            <circle cx="9" cy="13" r="0.9" fill="currentColor" />
            <circle cx="12" cy="13" r="0.9" fill="currentColor" />
            <circle cx="15" cy="13" r="0.9" fill="currentColor" />
        </svg>,
        HouseItemType.InteriorDoor => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="7" y="3" width="10" height="18" rx="1" stroke="currentColor" stroke-width="2" />
            <circle cx="14" cy="12" r="0.9" fill="currentColor" />
        </svg>,
        HouseItemType.SmokeDetector => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2" />
            <circle cx="12" cy="8" r="0.9" fill="currentColor" />
            <path d="M7 15c.5 1.5.5 2.5 0 4M12 15c.5 1.5.5 2.5 0 4M17 15c.5 1.5.5 2.5 0 4" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
        </svg>,
        _ => GetRoomTypeIcon(item.RoomType)
    };

    private RenderFragment GetRoomTypeIcon(RoomType roomType) => roomType switch
    {
        RoomType.Bedroom => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M3 20v-6a2 2 0 012-2h14a2 2 0 012 2v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M7 12V8a2 2 0 012-2h6a2 2 0 012 2v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M3 16h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>,
        RoomType.Bathroom => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M5 11V7a3 3 0 016 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            <path d="M3 11h18v3a3 3 0 01-3 3H6a3 3 0 01-3-3v-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M5 20h2M17 20h2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>,
        RoomType.Kitchen => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M4 4h16v8H4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M8 4v8M12 4v8M16 4v8" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
            <path d="M5 16h14v4H5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>,
        RoomType.LivingRoom => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M4 13a3 3 0 013-3h10a3 3 0 013 3v3H4v-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M7 10V8a2 2 0 012-2h6a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            <path d="M4 20h3M17 20h3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>,
        RoomType.DiningRoom => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M4 11h16v2H4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M7 13v5M17 13v5" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            <path d="M9 8h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>,
        RoomType.Hall => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="7" y="3" width="10" height="18" rx="1" stroke="currentColor" stroke-width="2" />
            <circle cx="14" cy="12" r="1" fill="currentColor" />
        </svg>,
        RoomType.Garage => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M4 20V8l8-4 8 4v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M8 20v-6h8v6M8 15h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>,
        RoomType.Basement => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M4 10l8-5 8 5v3H4v-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            <path d="M8 15v3M16 15v3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>,
        RoomType.Attic => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M3 11l9-7 9 7v9H3v-9z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M10 14h4v3h-4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>,
        RoomType.Office => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="4" y="4" width="16" height="11" rx="1" stroke="currentColor" stroke-width="2" />
            <path d="M10 19h4M12 15v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>,
        RoomType.LaundryRoom => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="5" y="3" width="14" height="18" rx="1" stroke="currentColor" stroke-width="2" />
            <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2" />
            <circle cx="9" cy="6" r="1" fill="currentColor" />
            <circle cx="13" cy="6" r="1" fill="currentColor" />
        </svg>,
        RoomType.Outdoor => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 3l3 5h-2l2 4h-2l2 4h-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M6 21h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>,
        _ => @<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="5" y="5" width="14" height="14" rx="2" stroke="currentColor" stroke-width="2" />
        </svg>
    };
}
}
