@page "/my-house"
@page "/{culture}/my-house"
@using System.Globalization
@using Microsoft.Extensions.Localization
@using Yanitor.Web.Domain
@using Yanitor.Web.Domain.Models
@using Yanitor.Web.Domain.Services
@inject IStringLocalizer<MyHouse> L
@inject NavigationManager Navigation
@inject IHouseConfigurationService HouseConfigService
@inject IActiveTaskService TaskService
@inject IItemProvider ItemProvider
@inject IStringLocalizer<TaskProvider> TaskL
@inject IStringLocalizer<HouseItemResources> ItemL
@rendermode InteractiveServer

<PageTitle>@L["PageTitle"]</PageTitle>

<section class="my-house">
    <header class="my-house__header">
        <h1 class="my-house__title">@L["PageTitle"]</h1>
        <p class="my-house__subtitle">@L["Subtitle"]</p>
    </header>

    @if (!_hasConfiguration)
    {
        <div class="my-house__empty">
            <div class="my-house__empty-content">
                <div class="my-house__empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 22V12h6v10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h2 class="my-house__empty-title">@L["BuildYourHouseTitle"]</h2>
                <p class="my-house__empty-text">@L["BuildYourHouseMessage"]</p>
            </div>
            <button type="button" class="my-house__add-button" @onclick="NavigateToBuilder" aria-label="@L["BuildYourHouseButton"]">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
    }
    else
    {
        <div class="my-house__cards">
            <a href="@GetActiveTasksUrl()" class="my-house__card-link">
                <article class="my-house__card my-house__card--tasks">
                    <div class="my-house__card-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </div>
                    <div class="my-house__card-content">
                        <h2 class="my-house__card-title">@L["TasksTitle"]</h2>
                        <p class="my-house__card-count">@_tasksCount</p>
                        @if (_nextTask != null)
                        {
                            <div class="my-house__next-task">
                                <p class="my-house__next-task-label">@L["NextTask"]:</p>
                                <p class="my-house__next-task-name">@($"{GetDisplayTaskName(_nextTask.Task)} ({GetDisplayItemName(_nextTask.Item)})")</p>
                                <p class="my-house__next-task-due">@GetDaysUntilDueText(_nextTask.DaysUntilDue)</p>
                            </div>
                        }
                        else
                        {
                            <p class="my-house__card-description">@L["NoTasksDescription"]</p>
                        }
                    </div>
                </article>
            </a>

            <a href="@GetItemsUrl()" class="my-house__card-link">
                <article class="my-house__card my-house__card--components">
                    <div class="my-house__card-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 22V12h6v10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="my-house__card-content">
                        <h2 class="my-house__card-title">@L["ComponentsTitle"]</h2>
                        <p class="my-house__card-count">@_componentsCount</p>
                        <p class="my-house__card-description">@L["ComponentsDescription"]</p>
                    </div>
                </article>
            </a>
        </div>
    }
</section>

@code {
    [Parameter]
    public string? Culture { get; set; }

    private int _componentsCount = 0;
    private int _tasksCount = 0;
    private ActiveTask? _nextTask = null;
    private bool _hasConfiguration = false;

    protected override async Task OnInitializedAsync()
    {
        _hasConfiguration = await HouseConfigService.HasConfigurationAsync();
        
        if (_hasConfiguration)
        {
            _componentsCount = (await ItemProvider.GetItemsForCurrentConfigurationAsync()).Count();
            _tasksCount = await TaskService.GetTaskCountAsync();
            _nextTask = await TaskService.GetNextTaskAsync();
        }
    }

    private void NavigateToBuilder()
    {
        var url = !string.IsNullOrEmpty(Culture) ? $"/{Culture}/house-builder" : "/house-builder";
        Navigation.NavigateTo(url);
    }

    private string GetItemsUrl()
    {
        return !string.IsNullOrEmpty(Culture) ? $"/{Culture}/items" : "/items";
    }

    private string GetActiveTasksUrl()
    {
        return !string.IsNullOrEmpty(Culture) ? $"/{Culture}/active-tasks" : "/active-tasks";
    }

    private string GetDaysUntilDueText(int days)
    {
        if (days == 0)
            return L["DueToday"];
        if (days == 1)
            return L["DueTomorrow"];
        if (days < 0)
            return L["Overdue", Math.Abs(days)];
        
        return L["DueInDays", days];
    }

    private string GetDisplayTaskName(MaintenanceTask task)
    {
        var name = TaskL[task.NameKey];
        return (!name.ResourceNotFound && !string.IsNullOrWhiteSpace(name.Value)) ? name.Value : task.NameKey;
    }

    private string GetDisplayItemName(HouseItem item)
    {
        // Try specific item name key first
        var specific = ItemL[$"Item_{item.Name}_Name"]; 
        if (!specific.ResourceNotFound && !string.IsNullOrWhiteSpace(specific.Value))
        {
            return specific.Value;
        }

        // Fallback to item type display
        var typeKey = $"ItemType_{item.ItemType}_Name";
        var typeName = ItemL[typeKey];
        if (!typeName.ResourceNotFound && !string.IsNullOrWhiteSpace(typeName.Value))
        {
            return typeName.Value;
        }

        // Final fallback: raw item name
        return item.Name;
    }
}
