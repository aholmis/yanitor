@page "/items"
@page "/{culture}/items"
@page "/components"
@page "/{culture}/components"
@using System.Globalization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Localization
@using Yanitor.Web.Domain
@using Yanitor.Web.Domain.Models
@using Yanitor.Web.Domain.Services
@using Yanitor.Web.Components
@inject IStringLocalizer<Components> L
@inject NavigationManager Navigation
@inject IItemProvider ItemProvider
@inject IStringLocalizer<HouseItemResources> ItemL
@inject IStringLocalizer<RoomTypeResources> RoomL
@rendermode InteractiveServer

<PageTitle>@L["PageTitle"]</PageTitle>

<section class="components">
    <header class="components__header">
        <a href="@GetMyHouseUrl()" class="components__back-button" aria-label="@L["BackToMyHouse"]">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </a>
        <div class="components__header-content">
            <h1 class="components__title">@L["PageTitle"]</h1>
            <p class="components__subtitle">@L["Subtitle"]</p>
        </div>
        <div class="components__actions">
            <button class="components__modify-button" type="button" @onclick="NavigateToBuilder" aria-label="@L["ModifyHouseAria"]">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M4 20h4l9.5-9.5a1.5 1.5 0 000-2.121L15.621 6.5a1.5 1.5 0 00-2.121 0L4 16v4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M13.5 7.5l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>@L["ModifyHouse"]</span>
            </button>
        </div>
    </header>

    @if (_componentsByRoomType.Count == 0)
    {
        <div class="components__empty">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M9 22V12h6v10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <p>@L["NoComponents"]</p>
        </div>
    }
    else
    {
        @foreach (var group in _componentsByRoomType.OrderBy(r => r.Key.ToString()))
        {
            <section class="components__room">
                <header class="components__room-header">
                    <div class="components__room-icon">
                        <Yanitor.Web.Components.IconFactory Room="group.Key" />
                    </div>
                    <h2 class="components__room-name">@GetDisplayRoomName(group.Key)</h2>
                </header>
                
                <div class="components__list">
                    @foreach (var component in group.Value)
                    {
                        <article class="components__item">
                            <div class="components__item-icon">
                                <Yanitor.Web.Components.IconFactory Item="component" />
                            </div>
                            <div class="components__item-content">
                                <h3 class="components__item-name">@GetDisplayItemName(component)</h3>
                            </div>
                        </article>
                    }
                </div>
            </section>
        }
    }
</section>

@code {
    [Parameter]
    public string? Culture { get; set; }

    private Dictionary<RoomType, List<HouseItem>> _componentsByRoomType = new();

    protected override async Task OnInitializedAsync()
    {
        var items = await ItemProvider.GetItemsForCurrentConfigurationAsync();
        _componentsByRoomType = items
            .GroupBy(i => i.RoomType)
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private string GetMyHouseUrl()
    {
        return string.IsNullOrWhiteSpace(Culture) 
            ? "/my-house" 
            : $"/{Culture}/my-house";
    }

    private void NavigateToBuilder()
    {
        var url = string.IsNullOrWhiteSpace(Culture) 
            ? "/house-builder" 
            : $"/{Culture}/house-builder";
        Navigation.NavigateTo(url);
    }

    private string GetDisplayRoomName(RoomType roomType)
    {
        var key = $"RoomType_{roomType}_Name";
        var roomName = RoomL[key];
        return !roomName.ResourceNotFound && !string.IsNullOrWhiteSpace(roomName.Value)
            ? roomName.Value
            : roomType.ToString();
    }

    private string GetDisplayItemName(HouseItem item)
    {
        var specific = ItemL[$"Item_{item.Name}_Name"];
        if (!specific.ResourceNotFound && !string.IsNullOrWhiteSpace(specific.Value))
        {
            return specific.Value;
        }

        var typeKey = $"ItemType_{item.ItemType}_Name";
        var typeName = ItemL[typeKey];
        if (!typeName.ResourceNotFound && !string.IsNullOrWhiteSpace(typeName.Value))
        {
            return typeName.Value;
        }

        return item.Name;
    }
}
