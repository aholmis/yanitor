@inherits LayoutComponentBase
@using Yanitor.Web.Services
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Antiforgery
@inject IUserContext UserContext
@inject NavigationManager Navigation
@inject HttpClient Http
@inject IAntiforgery Antiforgery
@inject IHttpContextAccessor HttpContextAccessor

<header class="main-header">
    <div class="main-header__content">
        @if (_userEmail != null && !IsSignInPage && !IsLandingPage)
        {
            <div class="main-header__user">
                <UserMenu UserEmail="@_userEmail" AntiForgeryToken="@_antiForgeryToken" />
            </div>
        }
        <CultureSelector />
    </div>
</header>

<main class="main-content">
    @Body
</main>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private string? _userEmail;
    private string? _antiForgeryToken;

    private bool IsSignInPage
    {
        get
        {
            var path = Navigation.ToBaseRelativePath(Navigation.Uri)
                .Split('?', '#')[0]
                .Trim('/');

            if (string.IsNullOrEmpty(path))
            {
                return false;
            }

            if (string.Equals(path, "sign-in", StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }

            var segments = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
            return segments.Length == 2 &&
                   string.Equals(segments[1], "sign-in", StringComparison.OrdinalIgnoreCase);
        }
    }

    private bool IsLandingPage
    {
        get
        {
            var path = Navigation.ToBaseRelativePath(Navigation.Uri)
                .Split('?', '#')[0]
                .Trim('/');

            if (string.IsNullOrEmpty(path))
            {
                return true; // "/" or "/{culture}"
            }

            if (string.Equals(path, "home", StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }

            var segments = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
            return segments.Length == 2 &&
                   string.Equals(segments[1], "home", StringComparison.OrdinalIgnoreCase);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _userEmail = await UserContext.GetCurrentUserEmailAsync();

        var httpContext = HttpContextAccessor.HttpContext;
        if (httpContext is not null)
        {
            var tokens = Antiforgery.GetAndStoreTokens(httpContext);
            _antiForgeryToken = tokens.RequestToken;
        }
    }

    private async Task SignOut()
    {
        var signOutUrl = new Uri("api/auth/sign-out", UriKind.Relative);
        var response = await Http.PostAsync(signOutUrl, content: null);
        response.EnsureSuccessStatusCode();

        _userEmail = null;

        var cultureSegment = Navigation.ToBaseRelativePath(Navigation.Uri)
            .Split('?', '#')[0]
            .Split('/', StringSplitOptions.RemoveEmptyEntries)
            .FirstOrDefault();

        var target = string.IsNullOrWhiteSpace(cultureSegment) ? "/sign-in" : $"/{cultureSegment}/sign-in";
        Navigation.NavigateTo(target, forceLoad: true);
    }
}
