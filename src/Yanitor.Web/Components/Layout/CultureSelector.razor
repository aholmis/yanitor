@rendermode InteractiveServer
@using System.Globalization
@using Microsoft.Extensions.Localization
@using Yanitor.Web.Resources
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResources> LCS

<section class="culture-selector">
    <label for="culture-select" class="culture-selector__label">@LCS["Language"]:</label>
    <select id="culture-select" @onchange="OnCultureChanged" class="culture-selector__select" aria-label="@LCS["SelectLanguage"]">
        @foreach (var culture in _supportedCultures)
        {
            <option value="@culture.Name" selected="@(culture.Name == CultureInfo.CurrentUICulture.Name)">@GetDisplayName(culture)</option>
        }
    </select>
</section>

@code {
    private readonly CultureInfo[] _supportedCultures = [ new("en"), new("no") ];

    private void OnCultureChanged(ChangeEventArgs e)
    {
        var newCulture = e.Value as string;
        if (string.IsNullOrWhiteSpace(newCulture)) return;

        // Get current path and replace or add culture
        var currentUri = new Uri(NavigationManager.Uri);
        var currentPath = currentUri.AbsolutePath;
        
        // Determine the new path with culture
        string newPath;
        var pathSegments = currentPath.Split('/', StringSplitOptions.RemoveEmptyEntries);
        
        if (pathSegments.Length > 0 && _supportedCultures.Any(c => c.Name.Equals(pathSegments[0], StringComparison.OrdinalIgnoreCase)))
        {
            // Replace existing culture in URL
            pathSegments[0] = newCulture;
            newPath = "/" + string.Join("/", pathSegments);
        }
        else
        {
            // Add culture to URL
            newPath = currentPath == "/" ? $"/{newCulture}" : $"/{newCulture}{currentPath}";
        }

        // Set culture via cookie and navigate to new path
        var setCultureUrl = $"/set-culture?culture={Uri.EscapeDataString(newCulture)}&returnUrl={Uri.EscapeDataString(newPath)}";
        NavigationManager.NavigateTo(setCultureUrl, forceLoad: true);
    }

    private string GetDisplayName(CultureInfo culture)
    {
        if (culture == null) return string.Empty;
        var cultureName = culture.NativeName;
        if (string.IsNullOrEmpty(cultureName)) return cultureName;
        return char.ToUpper(cultureName[0]) + cultureName.Substring(1);
    }
}
